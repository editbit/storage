<html>

<head>

  <meta charset="utf-8">

  <title>Example WebSocket</title>

</head>

<body>

<!-- ***************************************************** -->

Status: <span id="status"></span><br /><br />

Messages: <ul id="messages"></ul>

<div id="drop_zone">Drop files here</div>

<input type="file" id="files" name="files[]" multiple />

<output id="list"></output>

<div id="byte_range"></div>

<div id="byte_content"></div>


<table width="50%" border="1">
  <tr>
    <th>file name</th>
    <th>stored file name</th>
  </tr>

  <% fileList.forEach(function(item, index){ %>
    <tr>
      <td><a><%= item.name %></a></td>
      <td><a><%= item.stored_name %></a></td>
    </tr>
  <% }); %>
</table>

<!-- ***************************************************** -->

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<script type="text/javascript">

var upload_ip = null;

var upload_file_fd = null;

var upload_file_name = null;

var ws_upload = null;

if ('WebSocket' in window) {

  var ws = new WebSocket('ws://1.214.224.38:8000', 'example-echo');

  ws.binaryType="arraybuffer";

  ws.onopen = function () {

    $('#status').text('connected');

  };

  ws.onmessage = function (evt) {

    var msga = null;

    try{

      msga = JSON.parse(evt.data);

      $('#messages').append($('<li>').text('Received message: ' + evt.data+ ', '+ msga.stat));

      if(msga.stat == 'upload_start'){

        upload_ip = msga.upload_ip;

//////////////////////////

 

  ws_upload = new WebSocket('ws://'+upload_ip, 'example-echo');

  ws_upload.binaryType="arraybuffer";

  ws_upload.onopen = function () {

    alert('open websocket: '+upload_ip+', '+upload_file_name);

        sendFile(upload_file_fd, upload_file_name);

  };

  ws_upload.onmessage = function (evt) {

    

  };

  ws_upload.onclose = function () {

  };

 

//////////////////////////////

 

        

      }

      

    } catch (e){

      

    }

  };

  ws.onclose = function () {

    $('#status').text('connection is closed');

  };

}

else

  $('#status').text('WebSocket not supported.');

  function readBlob(file, opt_startByte, opt_stopByte, file_name) {

    var start = parseInt(opt_startByte) || 0;

    var stop = parseInt(opt_stopByte) || file.size - 1;

    var reader = new FileReader();

    // If we use onloadend, we need to check the readyState.

    reader.onloadend = function(evt) {

      if (evt.target.readyState == FileReader.DONE) { // DONE == 2

      var rawData = new ArrayBuffer();

          if(start == 0){

var msg = {

    type: "file_data",

    name: file_name,

    stat: 'start',

  };

ws_upload.send(JSON.stringify(msg));

          }

 

          rawData = evt.target.result;

          ws_upload.send(rawData);

          document.getElementById('byte_range').textContent = 

              ['Read bytes: ', start + 1, ' - ', stop + 1,

               ' of ', file.size, ' byte file'].join('');

          document.getElementById('byte_content').textContent = evt.target.result;

          if(stop+1 >= file.size - 1){

            upload_file_name = null;

            upload_file_fd = null;

var msg = {

    type: "file_data",

    name: file_name,

    stat: 'end',

  };

ws_upload.send(JSON.stringify(msg));

          }

      }

    };

    var blob = file.slice(start, stop + 1);

    //reader.readAsBinaryString(blob);

    reader.readAsArrayBuffer(blob);

  }

  function sendFile(file, file_name, file_size){

 alert('test: '+file_name);

    for(var i=0;i*65000 <= file.size-1;i++){

      readBlob(file, i*65000, (i+1)*65000-1, file_name);

    }

  }

 

  function handleFileSelect(evt) {

    var files = evt.target.files; // FileList object

    // files is a FileList of File objects. List some properties.

    var output = [];

    for (var i = 0, f; f = files[i]; i++) {

      output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',

                  f.size, ' bytes, last modified: ',

                  f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',

                  '</li>');

    }

    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';

 

    upload_file_name = escape(files[0].name);

    upload_file_fd = files[0];

var msg = {

    type: "file_data",

    name: escape(files[0].name),

    size: files[0].size,

    stat: 'upload',

  };

ws.send(JSON.stringify(msg));

  }

  

  function handleFileSelectDrag(evt) {

    evt.stopPropagation();

    evt.preventDefault();

    var files = evt.dataTransfer.files; // FileList object.

    // files is a FileList of File objects. List some properties.

    var output = [];

    for (var i = 0, f; f = files[i]; i++) {

      output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',

                  f.size, ' bytes, last modified: ',

                  f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',

                  '</li>');

    }

    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';

var msg = {

    type: "file_data",

    name: escape(files[0].name),

    stat: 'start',

  };

ws.send(JSON.stringify(msg));

 

    for(var i=0;i*65000 <= files[0].size-1;i++){

      readBlob(files[0], i*65000, (i+1)*65000-1);

    }

 

  }

  function handleDragOver(evt) {

    evt.stopPropagation();

    evt.preventDefault();

    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.

  }

  // Setup the dnd listeners.

  var dropZone = document.getElementById('drop_zone');

  dropZone.addEventListener('dragover', handleDragOver, false);

  dropZone.addEventListener('drop', handleFileSelectDrag, false);

 

  document.getElementById('files').addEventListener('change', handleFileSelect, false);

</script>

</body>

</html>

